<!-- user-profile.component.html -->
<ion-header class="ion-no-border">
  <ion-toolbar class="bg-gray-100" style="--background: #f3f4f6 !important">
    <ion-buttons slot="start">
      <app-icon-button size="sm" fontSize="xl" radius="md" icon="close" variant="transparent" color="danger" animation="pulse" width="md" (buttonClick)="dismiss()">
      </app-icon-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content class="bg-gray-100">
  <div class="md:container md:mx-auto md:px-4" *ngIf="user || true">
    <!-- Profile section -->
    <div class="flex flex-col items-center px-6 pb-6 pt-6 mb-3">
      <div class="mb-2 h-20 w-20 overflow-hidden rounded-full border-4 border-white shadow-lg bg-gray-200">
        <div class="h-full w-full flex items-center justify-center text-2xl font-bold text-gray-700">
          {{ getUserInitials() }}
        </div>
      </div>
      <h2 class="mt-2 text-center text-xl font-bold text-gray-900">{{ getUserFullName() }}</h2>
      <p class="text-center text-sm text-gray-600">{{ getUserEmail() }}</p>
      <!-- <p class="text-center text-sm text-gray-600">Rôles: {{ (userRoles$ | async)?.join(', ') }}</p>
      <p class="text-center text-sm text-gray-600">Rôle principal: {{ primaryRole$ | async }}</p> -->
      
      <!-- Badge de rôle principal -->
      <div class="mt-2 flex flex-row gap-2">
        <div *appShowForRole="UserRole.MOUKHADAM" class="px-3 py-1 bg-amber-200 text-amber-600 text-xs font-medium rounded-full">
          Moukhadam
        </div>
        <div *appShowForRole="UserRole.DISCIPLE" class="px-3 py-1 bg-green-100 text-green-600 text-xs font-medium rounded-full">
          Disciple
        </div>
        <div *appShowForVisiteurOnly class="px-3 py-1 bg-gray-200 text-gray-600 text-xs font-medium rounded-full">
          Visiteur
        </div>
        <div *appShowForRole="UserRole.G_DAHIRA" class="px-3 py-1 bg-blue-200 text-blue-900 text-xs font-medium rounded-full">
          Gestionnaire Dahira
        </div>
        <div *appShowForRole="UserRole.COLLECTE_FONDS" class="px-3 py-1 bg-violet-200 text-violet-900 text-xs font-medium rounded-full">
          Collecteur de fonds
        </div>
      </div>
    </div>
  
    <!-- Personal Information Section (non cliquable) -->
    <div class="px-6 py-4 bg-white rounded-xl shadow-sm mx-3 mb-3">
      <h3 class="mb-3 text-sm font-bold text-gray-900">Informations personnelles</h3>
      
      <div class="">
        <div class="flex items-center p-2.5">
          <ion-icon name="call" class="mr-3 text-gray-500 text-lg"></ion-icon>
          <span class="text-sm text-gray-700">{{ user?.phoneNumber}}</span>
        </div>
        
        <div class="flex items-center p-2.5">
          <ion-icon name="mail" class="mr-3 text-gray-500 text-lg"></ion-icon>
          <span class="text-sm text-gray-700">{{user?.email}}</span>
        </div>
        
        <div class="flex items-center p-2.5">
          <ion-icon name="home" class="mr-3 text-gray-500 text-lg"></ion-icon>
          <span class="text-sm text-gray-700">{{ user?.location?.address }}</span>
        </div>
        
        <div class="flex items-center p-2.5">
          <ion-icon name="location" class="mr-3 text-gray-500 text-lg"></ion-icon>
          <span class="text-sm text-gray-700">{{ user?.location?.region }} - {{ user?.location?.country }}</span>
        </div>
      </div>
    </div>
  
    <!-- Account Section -->
    <div class="px-6 py-4 bg-white rounded-xl shadow-sm mx-3 mb-3" *appHideForRole="UserRole.VISITEUR">
      <h3 class="mb-3 text-sm font-bold text-gray-900">Mon compte</h3>
      
      <div class="">
        <div class="flex items-center p-2.5 rounded-lg hover:bg-gray-50 active:bg-gray-100 transition-colors cursor-pointer">
          <ion-icon name="card" class="mr-3 text-gray-500 text-lg"></ion-icon>
          <span class="text-sm text-gray-700">Méthodes de paiement</span>
        </div>
        
        <div class="flex items-center p-2.5 rounded-lg hover:bg-gray-50 active:bg-gray-100 transition-colors cursor-pointer">
          <ion-icon name="pulse" class="mr-3 text-gray-500 text-lg"></ion-icon>
          <span class="text-sm text-gray-700">Activités</span>
        </div>
      </div>
    </div>

    <!-- Section Administration (Admin uniquement) -->
    <div *appShowForRole="UserRole.ADMIN" class="px-6 py-4 bg-white rounded-xl shadow-sm mx-3 mb-3">
      <h3 class="mb-3 text-sm font-bold text-gray-900">Administration</h3>
      
      <div class="">
        <div class="flex items-center p-2.5 rounded-lg hover:bg-gray-50 active:bg-gray-100 transition-colors cursor-pointer">
          <ion-icon name="people" class="mr-3 text-red-500 text-lg"></ion-icon>
          <span class="text-sm text-gray-700">Gérer les utilisateurs</span>
        </div>
        
        <div class="flex items-center p-2.5 rounded-lg hover:bg-gray-50 active:bg-gray-100 transition-colors cursor-pointer">
          <ion-icon name="settings" class="mr-3 text-red-500 text-lg"></ion-icon>
          <span class="text-sm text-gray-700">Configuration système</span>
        </div>
        
        <div class="flex items-center p-2.5 rounded-lg hover:bg-gray-50 active:bg-gray-100 transition-colors cursor-pointer">
          <ion-icon name="analytics" class="mr-3 text-red-500 text-lg"></ion-icon>
          <span class="text-sm text-gray-700">Statistiques globales</span>
        </div>
      </div>
    </div>

    <!-- Section Gestion (Admin et Moukhadam) -->
    <div *appShowForRole="[UserRole.MOUKHADAM, UserRole.G_DAHIRA, UserRole.COLLECTE_FONDS]" class="px-6 py-4 bg-white rounded-xl shadow-sm mx-3 mb-3">
      <h3 class="mb-3 text-sm font-bold text-gray-900">Gestion</h3>
      
      <div class="">
        <div *appShowForRole="UserRole.MOUKHADAM" (click)="navigateTo('disciples')" class="flex items-center p-2.5 rounded-lg hover:bg-gray-50 active:bg-gray-100 transition-colors cursor-pointer">
          <ion-icon name="people-circle" class="mr-3 text-gray-500 text-lg"></ion-icon>
          <span class="text-sm text-gray-700">Mes Disciples</span>
        </div>
        
        <div *appShowForRole="UserRole.G_DAHIRA" (click)="navigateTo('mydahira/'+user?.dahiraId!)" class="flex items-center p-2.5 rounded-lg hover:bg-gray-50 active:bg-gray-100 transition-colors cursor-pointer">
          <ion-icon name="home" class="mr-3 text-gray-500 text-lg"></ion-icon>
          <span class="text-sm text-gray-700">Ma Dahira</span>
        </div>
        
        <div *appShowForRole="UserRole.COLLECTE_FONDS" (click)="navigateTo('mycollecte')" class="flex items-center p-2.5 rounded-lg hover:bg-gray-50 active:bg-gray-100 transition-colors cursor-pointer">
          <ion-icon name="home" class="mr-3 text-gray-500 text-lg"></ion-icon>
          <span class="text-sm text-gray-700">Mes collectes de fonds</span>
        </div>
      </div>
    </div>

    <!-- Section Apprentissage (Disciple uniquement) -->
    <div *appShowForRole="UserRole.DISCIPLE" class="px-6 py-4 bg-white rounded-xl shadow-sm mx-3 mb-3">
      <h3 class="mb-3 text-sm font-bold text-gray-900">Mon Apprentissage</h3>
      
      <div (click)="navigateTo('mymoukhadam/'+ user?.mouqadamId)" class="flex items-center p-2.5 rounded-lg hover:bg-gray-50 active:bg-gray-100 transition-colors cursor-pointer">
        <ion-icon name="person-circle" class="mr-3 text-gray-500 text-lg"></ion-icon>
        <span class="text-sm text-gray-700">Mon Moukhadam</span>
      </div>
      <div class="">
      </div>
    </div>
  
    <!-- Demande Section - Visible selon le rôle -->
    <div class="px-6 py-4 bg-white rounded-xl shadow-sm mx-3 mb-3">
      <h3 class="mb-3 text-sm font-bold text-gray-900">Demandes</h3>
      
      <div class="">
        <!-- Demandes pour les visiteurs
        <div *appHideForRole="[UserRole.MOUKHADAM, UserRole.ADMIN, UserRole.DISCIPLE]" class="flex items-center p-2.5 rounded-lg hover:bg-gray-50 active:bg-gray-100 transition-colors cursor-pointer">
          <ion-icon name="person" class="mr-3 text-gray-500 text-lg"></ion-icon>
          <span class="text-sm text-gray-700">Devenir disciple d'un Moukhadam</span>
        </div> -->

        <!-- Demandes d'adhésion Dahira -->
        <div *appHideForRole="[UserRole.G_DAHIRA, UserRole.ADMIN]" (click)="navigateTo('dahiras')" class="flex items-center p-2.5 rounded-lg hover:bg-gray-50 active:bg-gray-100 transition-colors cursor-pointer">
          <ion-icon name="person" class="mr-3 text-gray-500 text-lg"></ion-icon>
          <span class="text-sm text-gray-700">Adhérer à une Dahira</span>
        </div>

        <!-- Demandes de création de Dahira -->
        <div *appHideForRole="[UserRole.G_DAHIRA, UserRole.ADMIN]" (click)="navigateTo('dahiras/create')" class="flex items-center p-2.5 rounded-lg hover:bg-gray-50 active:bg-gray-100 transition-colors cursor-pointer">
          <ion-icon name="person" class="mr-3 text-gray-500 text-lg"></ion-icon>
          <span class="text-sm text-gray-700">Créer Dahira</span>
        </div>

        <!-- Demandes de création de collecte de fonds -->
        <div *appHideForRole="[UserRole.COLLECTE_FONDS, UserRole.ADMIN]" (click)="navigateTo('finances/create-collect')" class="flex items-center p-2.5 rounded-lg hover:bg-gray-50 active:bg-gray-100 transition-colors cursor-pointer">
          <ion-icon name="person" class="mr-3 text-gray-500 text-lg"></ion-icon>
          <span class="text-sm text-gray-700">Créer une collecte de fonds</span>
        </div>
        
        <!-- Demande pour devenir Moukhadam (pas pour les admins) -->
        <div *appHideForRole="[UserRole.MOUKHADAM, UserRole.DISCIPLE]" (click)="becomeMoukhadam()" class="flex items-center p-2.5 rounded-lg hover:bg-gray-50 active:bg-gray-100 transition-colors cursor-pointer">
          <ion-icon name="person-circle" class="mr-3 text-gray-500 text-lg"></ion-icon>
          <span class="text-sm text-gray-700">Devenir Moukhadam</span>
        </div>
        
        <!-- Mes demandes - visible pour tous les utilisateurs connectés -->
        <div (click)="navigateTo('demandes')" class="flex items-center p-2.5 rounded-lg hover:bg-gray-50 active:bg-gray-100 transition-colors cursor-pointer">
          <ion-icon name="receipt" class="mr-3 text-gray-500 text-lg"></ion-icon>
          <span class="text-sm text-gray-700">Mes demandes</span>
        </div>
        
        <!-- Mes demandes - visible pour tous les utilisateurs connectés -->
        <div *appShowForRole="[UserRole.G_DAHIRA]" (click)="navigateTo('demande-dahira/'+user?.dahiraId)" class="flex items-center p-2.5 rounded-lg hover:bg-gray-50 active:bg-gray-100 transition-colors cursor-pointer">
          <ion-icon name="receipt" class="mr-3 text-gray-500 text-lg"></ion-icon>
          <span class="text-sm text-gray-700">Les adhésions de mon Dahira</span>
        </div>
      </div>
    </div>
  
    <!-- Activities Section -->
    <div *appHideForRole="UserRole.VISITEUR" class="px-6 py-4 bg-white rounded-xl shadow-sm mx-3 mb-3">
      <h3 class="mb-3 text-sm font-bold text-gray-900">Activités de la Faydah</h3>
      
      <div class="">
        <div class="flex items-center p-2.5 rounded-lg hover:bg-gray-50 active:bg-gray-100 transition-colors cursor-pointer">
          <ion-icon name="people" class="mr-3 text-gray-500 text-lg"></ion-icon>
          <span class="text-sm text-gray-700">Dahira Cheikh Al Islam</span>
        </div>
        
        <div class="flex items-center p-2.5 rounded-lg hover:bg-gray-50 active:bg-gray-100 transition-colors cursor-pointer">
          <ion-icon name="map" class="mr-3 text-gray-500 text-lg"></ion-icon>
          <span class="text-sm text-gray-700">Kaolack - Sénégal</span>
        </div>
        
        <!-- Contenu avancé pour les membres connectés -->
        <div  class="flex items-center p-2.5 rounded-lg hover:bg-gray-50 active:bg-gray-100 transition-colors cursor-pointer">
          <ion-icon name="calendar" class="mr-3 text-gray-500 text-lg"></ion-icon>
          <span class="text-sm text-gray-700">Événements à venir</span>
        </div>
      </div>
    </div>
  
    <div class="px-6 py-4 mx-3 mb-3">
      <div class="mb-4">
        <app-button fontWeight="normal" text="Changer mon mot de passe" size="sm" radius="md" variant="transparent" color="light" width="full" (buttonClick)="openChangePasswordModal()">
        </app-button>
      </div>
      
      <app-button [isLoading]="isLoading" fontWeight="normal" text="SE DÉCONNECTER" size="md" radius="md" iconEnd="log-out" variant="light" color="danger" width="full" (buttonClick)="openLogoutConfirm()">
      </app-button>
    </div>
  </div>

  <!-- Boîte de dialogue de confirmation de déconnexion -->
  <div *ngIf="showLogoutConfirm" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-40">
    <div class="bg-white rounded-xl shadow-xl p-8 max-w-sm w-full text-center">
      <div class="mb-4">
        <ion-icon name="log-out-outline" class="text-red-500 text-4xl mb-2"></ion-icon>
        <h2 class="text-lg font-bold text-gray-900 mb-2">Déconnexion</h2>
        <p class="text-gray-700">Voulez-vous vraiment vous déconnecter&nbsp;?</p>
      </div>
      <div class="flex justify-center gap-4 mt-6">
        <button (click)="closeLogoutConfirm()" class="px-4 py-2 rounded-md bg-gray-100 text-gray-700 hover:bg-gray-200 font-medium">Annuler</button>
        <button (click)="confirmLogout()" class="px-4 py-2 rounded-md bg-red-600 text-white hover:bg-red-700 font-medium">Se déconnecter</button>
      </div>
    </div>
  </div>

  <!-- Modale de changement de mot de passe -->
  <div *ngIf="showChangePasswordModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-40">
    <div class="bg-white rounded-xl shadow-xl p-8 max-w-sm w-full text-center">
      <h2 class="text-lg font-bold text-gray-900 mb-4">Changer mon mot de passe</h2>
      <form [formGroup]="changePasswordForm" (ngSubmit)="changePassword()" autocomplete="off">
        <div class="mb-4 text-left">
          <label class="block text-sm font-medium text-gray-700 mb-1">Ancien mot de passe</label>
          <input type="password" formControlName="oldPassword" class="w-full px-4 py-2 border rounded-md focus:ring-2 focus:ring-green-500 focus:outline-none" placeholder="Ancien mot de passe">
          <div *ngIf="changePasswordForm.get('oldPassword')?.touched && changePasswordForm.get('oldPassword')?.invalid" class="text-xs text-red-500 mt-1">Mot de passe requis (min 6 caractères)</div>
        </div>
        <div class="mb-4 text-left">
          <label class="block text-sm font-medium text-gray-700 mb-1">Nouveau mot de passe</label>
          <input type="password" formControlName="newPassword" class="w-full px-4 py-2 border rounded-md focus:ring-2 focus:ring-green-500 focus:outline-none" placeholder="Nouveau mot de passe">
          <div *ngIf="changePasswordForm.get('newPassword')?.touched && changePasswordForm.get('newPassword')?.invalid" class="text-xs text-red-500 mt-1">Mot de passe requis (min 6 caractères)</div>
        </div>
        <div class="mb-4 text-left">
          <label class="block text-sm font-medium text-gray-700 mb-1">Confirmer le nouveau mot de passe</label>
          <input type="password" formControlName="confirmPassword" class="w-full px-4 py-2 border rounded-md focus:ring-2 focus:ring-green-500 focus:outline-none" placeholder="Confirmer le mot de passe">
          <div *ngIf="changePasswordForm.hasError('passwordMismatch') && changePasswordForm.get('confirmPassword')?.touched" class="text-xs text-red-500 mt-1">Les mots de passe ne correspondent pas.</div>
        </div>
        <div *ngIf="changePasswordError" class="text-red-500 text-sm mb-2">{{ changePasswordError }}</div>
        <div *ngIf="changePasswordSuccess" class="text-green-600 text-sm mb-2">{{ changePasswordSuccess }}</div>
        <div class="flex justify-center gap-4 mt-6">
          <button type="button" (click)="closeChangePasswordModal()" class="px-4 py-2 rounded-md bg-gray-100 text-gray-700 hover:bg-gray-200 font-medium">Annuler</button>
          <button type="submit" [disabled]="isChangingPassword || changePasswordForm.invalid" class="px-4 py-2 rounded-md bg-green-600 text-white hover:bg-green-700 font-medium" [ngClass]="{'opacity-60': isChangingPassword || changePasswordForm.invalid}">
            <span *ngIf="!isChangingPassword">Valider</span>
            <span *ngIf="isChangingPassword">...</span>
          </button>
        </div>
      </form>
    </div>
  </div>




</ion-content>