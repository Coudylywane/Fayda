<!-- add-user-modal.component.html -->
<ion-header>
  <ion-toolbar>
    <div class="flex justify-between items-center px-4">
      <ion-title class="text-lg font-semibold">Ajouter un utilisateur</ion-title>
      <ion-button fill="clear" (click)="dismiss()" [disabled]="isSubmitting">
        <ion-icon name="close-outline" slot="icon-only"></ion-icon>
      </ion-button>
    </div>
  </ion-toolbar>
</ion-header>
<!-- Ajoutez ce bouton temporaire juste apr√®s <ion-header> -->
<div class="px-6 py-2 bg-blue-50">
  <button 
    (click)="testDirectAPI()" 
    class="w-full bg-blue-500 text-white px-4 py-2 rounded mb-2 hover:bg-blue-600 transition-colors">
    üîç Test API Direct (Debug)
  </button>
</div>
<ion-content>
  <div class="px-6 py-4">
    <!-- Photo de profil cliquable -->
    <div class="mb-6 flex justify-center">
      <div class="relative w-24 h-24 rounded-full overflow-hidden bg-gray-200 border-2 border-green-500 cursor-pointer"
           (click)="onImageClick()">
        <img [src]="imagePreview" alt="Avatar" class="w-full h-full object-cover" />
        <div class="absolute inset-0 bg-black bg-opacity-0 hover:bg-opacity-30 flex items-center justify-center transition-all">
          <ion-icon name="camera-outline" class="text-white text-2xl opacity-0 hover:opacity-100"></ion-icon>
        </div>
        <div class="absolute bottom-0 right-0 bg-green-600 rounded-full p-1.5 text-white">
          <ion-icon name="camera-outline" class="text-sm"></ion-icon>
        </div>
      </div>
    </div>
    <p class="text-center text-xs text-gray-500 mb-4">Cliquez sur la photo pour changer</p>

    <div class="space-y-4">
      <!-- Pr√©nom -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">
          Pr√©nom <span class="text-red-500">*</span>
        </label>
        <input
          type="text"
          [(ngModel)]="newUser.firstName"
          class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-green-500"
          placeholder="Pr√©nom"
          [class.border-red-500]="newUser.firstName && !newUser.firstName.trim() && newUser.firstName.length > 0"
        />
      </div>

      <!-- Nom -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">
          Nom <span class="text-red-500">*</span>
        </label>
        <input
          type="text"
          [(ngModel)]="newUser.lastName"
          class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-green-500"
          placeholder="Nom de famille"
          [class.border-red-500]="newUser.lastName && !newUser.lastName.trim() && newUser.lastName.length > 0"
        />
      </div>

      <!-- Email -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">
          Email <span class="text-red-500">*</span>
        </label>
        <input
          type="email"
          [(ngModel)]="newUser.email"
          (ngModelChange)="onEmailChange()"
          class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-green-500"
          placeholder="exemple@email.com"
          [class.border-red-500]="newUser.email && !isValidEmail(newUser.email) && newUser.email.length > 0"
        />
        <small class="text-red-500" *ngIf="newUser.email && !isValidEmail(newUser.email) && newUser.email.length > 0">
          Format d'email invalide
        </small>
      </div>

      <!-- Nom d'utilisateur -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">
          Nom d'utilisateur
        </label>
        <input
          type="text"
          [(ngModel)]="newUser.username"
          class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-green-500"
          placeholder="G√©n√©r√© automatiquement depuis l'email"
        />
        <small class="text-gray-500">Laissez vide pour g√©n√©rer automatiquement</small>
      </div>

      <!-- Mot de passe -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">
          Mot de passe
        </label>
        <input
          type="password"
          [(ngModel)]="newUser.password"
          class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-green-500"
          placeholder="Laissez vide pour g√©n√©rer automatiquement"
        />
        <small class="text-gray-500">Un mot de passe temporaire sera g√©n√©r√© si vide</small>
      </div>

      <!-- T√©l√©phone -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">T√©l√©phone</label>
        <input
          type="tel"
          [(ngModel)]="newUser.phoneNumber"
          class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-green-500"
          placeholder="+221 77 123 45 67"
          [class.border-red-500]="newUser.phoneNumber && !isValidPhone(newUser.phoneNumber) && newUser.phoneNumber.length > 0"
        />
        <small class="text-red-500" *ngIf="newUser.phoneNumber && !isValidPhone(newUser.phoneNumber) && newUser.phoneNumber.length > 0">
          Format de t√©l√©phone invalide
        </small>
      </div>

      <!-- Genre -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">
          Genre <span class="text-red-500">*</span>
        </label>
        <select
          [(ngModel)]="newUser.gender"
          class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-green-500"
        >
          <option value="">S√©lectionnez un genre</option>
          <option *ngFor="let gender of genderOptions" [value]="gender.value">
            {{ gender.label }}
          </option>
        </select>
      </div>

      <!-- Date de naissance -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">
          Date de naissance <span class="text-red-500">*</span>
        </label>
        <input
          type="date"
          [(ngModel)]="newUser.dateOfBirth"
          class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-green-500"
          [max]="today"
        />
      </div>

      <!-- Cat√©gorie -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">
          Cat√©gorie <span class="text-red-500">*</span>
        </label>
        <select
          [(ngModel)]="newUser.category"
          (ngModelChange)="onCategoryChange()"
          class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-green-500"
        >
          <option value="">S√©lectionnez une cat√©gorie</option>
          <option *ngFor="let cat of categoryOptions" [value]="cat.value">
            {{ cat.label }}
          </option>
        </select>
      </div>

      <!-- Statut actif -->
      <div class="flex items-center justify-between">
        <label class="text-sm font-medium text-gray-700">Compte actif</label>
        <ion-toggle [(ngModel)]="newUser.active" color="success"></ion-toggle>
      </div>

      <!-- Section Localisation -->
      <div class="border-t pt-4 mt-6">
        <h3 class="text-md font-medium text-gray-800 mb-4">Informations g√©ographiques</h3>

        <!-- Nationalit√© -->
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-1">Nationalit√©</label>
          <input
            type="text"
            [ngModel]="newUser.location?.nationality"
            (ngModelChange)="updateLocation('nationality', $event)"
            class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-green-500"
            placeholder="S√©n√©galaise"
          />
        </div>

        <!-- Pays -->
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-1">
            Pays <span class="text-red-500">*</span>
          </label>
          <input
            type="text"
            [ngModel]="newUser.location?.country"
            (ngModelChange)="updateLocation('country', $event)"
            class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-green-500"
            placeholder="S√©n√©gal"
          />
        </div>

        <!-- R√©gion -->
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-1">
            R√©gion <span class="text-red-500">*</span>
          </label>
          <input
            type="text"
            [ngModel]="newUser.location?.region"
            (ngModelChange)="updateLocation('region', $event)"
            class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-green-500"
            placeholder="Dakar"
          />
        </div>

        <!-- D√©partement -->
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-1">D√©partement</label>
          <input
            type="text"
            [ngModel]="newUser.location?.department"
            (ngModelChange)="updateLocation('department', $event)"
            class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-green-500"
            placeholder="Dakar"
          />
        </div>

        <!-- Adresse -->
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-1">
            Adresse <span class="text-red-500">*</span>
          </label>
          <textarea
            [ngModel]="newUser.location?.address"
            (ngModelChange)="updateLocation('address', $event)"
            class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-green-500"
            placeholder="Adresse compl√®te"
            rows="2"
          ></textarea>
        </div>
      </div>
    </div>

    <!-- Bouton de validation -->
    <div class="mt-8">
      <button
        (click)="saveUser()"
        [disabled]="!isFormValid() || isSubmitting"
        class="w-full py-3 bg-green-600 text-white rounded-lg font-medium hover:bg-green-700 transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed flex items-center justify-center"
      >
        <ion-spinner name="circular" *ngIf="isSubmitting" class="mr-2"></ion-spinner>
        {{ isSubmitting ? 'Cr√©ation en cours...' : 'Ajouter l\'utilisateur' }}
      </button>

      <p class="text-xs text-gray-500 mt-2 text-center">* Champs obligatoires</p>
    </div>
  </div>
</ion-content>